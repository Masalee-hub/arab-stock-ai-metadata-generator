<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="widht=device-widht, initial-scale=1.0">
    <title>Arabs Stock AI Keywords</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 400px;;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: whitesmoke;
        }

        .popup-header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .popup-header h1 {
            font-size: 1.4em;
            margin-bottom: 8px;
        }

        .popup-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .popup-content {
            padding: 20px;
        }

        .status-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .status-indicator.active {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-indicator.inactive {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .feature-list {
            list-style: none;
            margin-bottom: 20px;
        }

        .feature-list li {
            padding: 8px 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-list li::before{
            content: 'âœ¨';
            font-size: 1.1em;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .popup-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .popup-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        .popup-btn.primary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border-color: transparent;
        }

        .popup-btn.primary:hover {
            background: white;
            transform: translateY(-2px);
        }

        .settings-section {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 20px;
            margin-top: 20px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            font-size: 0.9em;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .version-info {
            text-align: center;
            padding: 15px 0;
            font-size: 0.8em;
            opacity: 0.7;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.9                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ;
        }

        .quick-actions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .quick-actions h3 {
            font-size: 1em;
            margin-bottom: 10px;
            text-align: center;
        }

        .quick-actions-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8em;
            margin: 3px;
            transition: all 0.3s ease;
        }

        .quick-actions-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="popup-header">
        <h1>Arabs Stock AI Keywords Generated</h1>
        <p>AI-powered metadata for Arab contributors</p>
    </div>

    <div class="popup-content">
        <div class="status-section">
            <div id="connectionStatus">
                <span class="status-indicator inactive" id="statusDot"></span>
                <span d="statusText">Checking connection...</span>
            </div>

            <div class="ai-provider-section" style="margin-top: 15px;">
                <label for="aiProviderSelect" style="font-size: 0.9em; margin-bottom: 5px; display: block;">AI Provider:</label>
                <select id="aiProviderSelect" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255, 255, 255, 0.1); color: white; font-size: 0.9em;">
                    <option value="">Loading providers...</option>
                </select>

                <div id="apiKeySection" sty;e="margin-top: 10px; display: none;">
                    <input type="password" id="apiKeyInput" placeholder="Enter API key cuy..." style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white; margin-bottom: 8px;">
                    <div style="display: flex; gap: 5px">
                        <button class="quick-actions-btn" onclick="setProvider()" style="flex: 1;">Set Provider</button>
                        <button class="quick-actions-btn" onclick="testProvider()" style="flex: 1;">Test</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="imagesProcessed">0</span>
                <span class="stat-label">Images Processed</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="keywordsGenerated">0</span>
                <span class="stat-label">Keywords Generated</span>
            </div>
        </div>

        <div class="quick-actions">
            <h3>Quick Actions</h3>
            <button class="quick-actions-btn" onclick="openArabsStock()">ðŸ”‘ Open Arabs Stock</button>
            <button class="quick-actions-btn" onclick="startPythonServer()">Start Python Server</button>
            <button class="quick-actions-btn" onclick="testConnection()">Test Connection</button>
            <button class="quick-actions-btn" onclick="clearData()">Clear Data</button>
        </div>

        <div class="feature-list">
            <li>AI-generated title in Arabic & English</li>
            <li>Smart keyword suggestions</li>
            <li>Automatic category detection</li>
            <li>License type recomendation</li>
            <li>SEO optimization for Arab Market</li>
            <li>Bilingual metadata support</li>
        </div>

        <div class="action-buttons">
            <button class="popup-btn primary" onclick="activateExtension()">
                Activate Extension
            </button>
            <button class="popup-btn" onclick="openSettings()">
                Setting
            </button>
            <button class="popup-btn" onclick="openHelp()">
                Help & Guide
            </button>
        </div>

        <div class="settings-section">
            <div class="settings-item">
                <span>Auto-fill forms</span>
                <label class="switch">
                    <input type="checkbox" id="autoFillToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <span>Show notifications</span>
                <label class="switch">
                    <input type="checkbox" id="notificationsToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <span>Arabic priority</span>
                <label class="switch">
                    <input type="checkbox" id="arabicPriorityToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="version-info">
        Arabs Stock AI keyword v0.0.1<br>
        <small>Powered by Claude.ai and Masalee Dev</small>
    </div>

    <script>
        // Popup functionality
        let stats = {
            imagesProcessed: 0,
            keywordGenerated: 0
        };

        let availableProviders = [];
        let currentProvider = 'offline';

        // Initialize popup
        document.addEventListener('DOMContentLoaded', function() {
           loadSettings();
           checkConnectionStatus();
           loadAvailableProviders();
           updateStats(); 
        });

        async function loadAvailableProviders() {
            try {
                const response = await fetch('http://localhost:5000/api/providers');
                if (response.ok) {
                    const data = await response.json();
                    availableProviders = data.providers;
                    currentProvider = data.current_provider;

                    populateProviderSelect();
                } else {
                    console.log('Failed to load providers');
                }
            } catch (error) {
                console.log('Server offline, using offline mode');
                setOfflineMode();
            }
        }

        function populateProviderSelect() {
            const select = document.getElementById('aiProviderSelect');
            select.innerHTML ='';

            availableProviders.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.name;
                option.textContent = `${provider.display_name} - ${provider.description}`;
                if (provider.current) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Add event listener for provider selection
            select.addEventListener('change', handleProviderChange);

            // Trigger initial change to show/hide API key section
            handleProviderChange();
        }

        function handleProviderChange() {
            const select = document.getElementById('aiProviderSelect');
            const apiKeySection = document.getElementById('apiKeySection');
            const selectedProvider = availableProviders.find(p => p.name === select.value);

            if (selectedProvider && selectedProvider.requires_api_key) {
                apiKeySection.style.display = 'block';
                document.getElementById('apiKeyInput').placeholder = `Enter ${selectedProvider.display_name} API Key...`;
            } else {
                apiKeySection.style.display = 'none';
            }
        }

        async function setProvider() {
            const select = document.getElementById('aiProviderSelect');
            const apiKeyInput = document.getElementById('aiKeyInput');
            const selectedProvider = select.value;
            const apiKey = apiKeyInput.value.trim();

            if (!selectedProvider) {
                showNotification('Please select a provider', 'error');
                return;
            }

            const selectedProviderInfo = availableProviders.find(p => p.name === selectedProvider);
            if (selectedProviderInfo.requires_api_key && !apiKey) {
                showNotification('API key is required for this provider', 'error');
                return;
            }

            try {
                showNotification('Setting AI Provider...');

                const response = await fetch('http://localhost:5000/api/providers/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: selectedProvider,
                        api_key: apiKey,
                        model: selectedProviderInfo.models[0] // Use default model
                    })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    showNotification(`Successfully switched to ${selectedProvider}`);
                    currentProvider = selectedProvider;

                    // Save API key securely
                    if (apiKey) {
                        chrome.storage.sync.set({ [`${selectedProvider}_api_key`]: apiKey});
                    }

                    // Clear API key input for security
                    apiKeyInput.value = '';

                    // Refresh connection status
                    checkConnectionStatus();
                } else {
                    showNotification(result.message || 'Failed to set provider', 'error');
                }
            } catch (error) {
                showNotification('Error setting provider: ' + error.message, 'error');
            }
        }

        async function testProvider() {
            const select = document.getElementById('aiProviderSelect');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const selectedProvider = select.value;
            const apiKey = apiKeyInput.value.trim();

            if (!selectedProvider) {
                showNotification('Please select a provider', 'error');
                return;
            }

            try {
                showNotification('Testing provider connection...');

                const response = await fetch('http:localhost:5000/api/test-provider', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: selectedProvider,
                        api_key: apiKey
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showNotification(`${selectedProvider} connection successful!`);
                } else {
                    showNotification(`${selectedProvider} connection failed : ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification('Test failed: ' + error.message, 'error');
            }
        }

        function setOfflineMode() {
            const select = document.getElementById('aiProviderSelect');
            select.innerHTML = '<option value="offline">Offline Mode - Basic Analysis</option>';
            document.getElementById('apiKeySection').style.display = 'none';
            currentProvider = 'offline';
        }

        async function checkConnectionStatus() {
            try {
                const response = await fetch('http://localhost:5000/api/health');
                if (response.ok) {
                    const data = await response.json();
                    setConnectionStatus(true, `Connected via ${data.current_provider.toUpperCase()}`);
                } else {
                    setConnectionStatus(false, 'Server error');
                }
            } catch (error) {
                setConnectionStatus(false, 'Pyhton server offline');
            }
        }

        function setConnectionStatus(connected, message) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            statusDot.className = `status-indicator ${connected ? 'active' : 'inactive'}`;
            statusText.textContent = message;
        }

        function loadSettings() {
            chrome.storage.sync.get([
                'autoFillEnabled',
                'notificationsEnabled',
                'arabicPriority',
                'imagesProcessed',
                'keywordsGenerated'
            ], function (result) {
                document.getElementById('autoFillToggle').checked = result.autoFillEnabled !== false;
                document.getElementById('notificationsToggle').checked = result.notificatiosEnabled !== false;
                document.getElementById('arabicPriorityToggle').checked = result.arabicPriority === true;

                stats.imagesProcessed = result.imagesProcessed || 0;
                stats.keywordGenerated = result.keywordGenerated || 0;
                updateStats();
            });
        }

        function updateStats() {
            document.getElementById('imagesProcessed').textContent = stats.imagesProcessed;
            document.getElementById('keywordsGenerated').textContent = stats.keywordGenerated;
        }

        function saveSettings() {
            const settings = {
                autoFillEnabled: document.getElementById('autoFillToggle').checked,
                notificatiosEnabled: document.getElementById('notificationsToggle').checked,
                arabicPriority: document.getElementById('arabicPriorityToggle').checked,
                imagesProcessed: stats.imagesProcessed,
                keywordGenerated: stats.keywordGenerated
            };

            chrome.storage.sync.set(settings);
        }

        // Event listeners for settings
        document.getElementById('autoFillToggle'),addEventListener('change', saveSettings);
        document.getElementById('notificationsToggle').addEventListener('change', saveSettings);
        document.getElementById('arabicPriorityToggle').addEventListener('change', saveSettings);

        // Action functions
        function openArabsStock() {
            chrome.tabs.create({ url: 'https://contributor.arabsstock.com/en/warehouse?type=Images' });
            showNotification('Opening Arabs stock contributor dashboard....');
        }

        function startPythonServer() {
            showNotification('Please run: python app.py in your extension folder');
        }

        async function testConnection() {
            showNotification('Testing connection...');
            await checkConnectionStatus();
        }

        function clearData(){
            if(confirm('Clear all extension data?')) {
                chrome.storage.sync.clear(() => {
                    stats = { imagesProcessed: 0, keywordGenerated: 0 };
                    updateStats();
                    showNotification('Data cleared successfully');
                });
            }
        }

        function activateExtension() {
            chrome.tabs.query({ active: true, currentWindow: true}, function(tabs) {
                const currentTab = tab[0];

                if (currentTab.url.includes('arabsstock.com')) {
                    chrome.tabs.sendMessage(currentTabb.id, { action: 'activate' });
                    showNotification('Extension activated on Arabs Stock!');
                    window.close();
                } else {
                    showNotification('Please navigaate to Arabs Stock first!');
                    openArabsStock();
                }
            });
        }

        function openSettings() {
            chrome.tabs.create({ url: chrome.runtime.getURL('setting.html') });
        }

        function openHelp() {
            chrome.tabs.create({ url: chrome.runtime.getURL('help.html') });
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#dc3545' : '#28a745';

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Listen for message from content script
        chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
            if (request.action === 'updateStats') {
                stats.imagesProcessed += request.imagesProcessed || 0;
                stats.keywordGenerated += request.keywordGenerated || 0;
                updateStats();
                saveSettings();
            }
        });

        // Auto-refresh connection status
        setInterval(checkConnectionStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>